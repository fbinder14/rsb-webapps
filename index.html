<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSB Webapps</title>

    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>

    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .settings-btn {
            background: none;
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.6);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: #1a1a2e;
        }

        .modal h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            color: #1a1a2e;
            font-size: 1rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1rem;
        }

        .modal label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #555;
        }

        .modal input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .modal input:focus {
            outline: none;
            border-color: #4a6cf7;
        }

        .modal .help-text {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.82rem;
            color: #666;
            line-height: 1.5;
        }

        .modal .help-text strong {
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4a6cf7;
            color: #fff;
        }

        .btn-primary:hover { background: #3a5ce5; }

        .btn-success {
            background: #22c55e;
            color: #fff;
        }

        .btn-success:hover { background: #16a34a; }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover { background: #dc2626; }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover { background: #d1d5db; }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Editor Section */
        .editor-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .editor-section h2 {
            margin-bottom: 1rem;
            color: #1a1a2e;
            font-size: 1.2rem;
        }

        .filename-row {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filename-row input {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .filename-row input:focus {
            outline: none;
            border-color: #4a6cf7;
        }

        .filename-row span {
            color: #888;
            font-weight: 600;
        }

        .CodeMirror {
            height: 400px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .editor-buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Description box in editor */
        .desc-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .desc-box.active { display: block; }

        .desc-box label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 0.3rem;
        }

        .desc-box input, .desc-box textarea {
            width: 100%;
            padding: 0.5rem 0.7rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            margin-bottom: 0.6rem;
        }

        .desc-box textarea { resize: vertical; height: 50px; }

        .desc-row { display: flex; gap: 0.8rem; }
        .desc-row > div { flex: 1; }

        /* Preview */
        .preview-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: none;
        }

        .preview-section.active { display: block; }

        .preview-section h2 {
            margin-bottom: 1rem;
            color: #1a1a2e;
            font-size: 1.2rem;
        }

        .preview-frame {
            width: 100%;
            height: 400px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        /* App List */
        .app-list-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .app-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .app-list-header h2 {
            color: #1a1a2e;
            font-size: 1.2rem;
            margin: 0;
        }

        .filter-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-bar input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .filter-bar input:focus {
            outline: none;
            border-color: #4a6cf7;
        }

        .filter-bar select {
            padding: 0.5rem 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #fff;
            cursor: pointer;
        }

        .app-list-empty {
            text-align: center;
            color: #999;
            padding: 2rem;
        }

        .app-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 0.8rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background 0.15s;
        }

        .app-item:hover { background: #f9fafb; }

        .app-item-info { flex: 1; min-width: 0; }

        .app-item-name {
            font-weight: 600;
            color: #1a1a2e;
        }

        .app-item-name a {
            color: #4a6cf7;
            text-decoration: none;
        }

        .app-item-name a:hover { text-decoration: underline; }

        .app-item-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.3rem;
        }

        .badge-fach {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-stufe {
            background: #fef3c7;
            color: #92400e;
        }

        .app-item-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .btn-sm {
            padding: 0.35rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        /* QR Modal */
        .qr-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .qr-modal-overlay.active {
            display: flex;
        }

        .qr-modal {
            background: #fff;
            border-radius: 16px;
            padding: 2rem 2.5rem;
            text-align: center;
            box-shadow: 0 16px 48px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .qr-modal h3 {
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
            word-break: break-all;
        }

        .qr-modal-code {
            display: inline-block;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .qr-modal-url {
            font-size: 0.85rem;
            color: #4a6cf7;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        .qr-modal-url a {
            color: #4a6cf7;
            text-decoration: none;
        }

        .qr-modal-url a:hover { text-decoration: underline; }

        .qr-modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        /* Status messages */
        .status {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
            display: none;
        }

        .status.active { display: block; }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 0.4rem;
        }

        .spinner-dark {
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #4a6cf7;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Not configured banner */
        .setup-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .setup-banner button {
            margin-left: 0.5rem;
        }

        .app-count {
            font-size: 0.85rem;
            color: #888;
            font-weight: normal;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .CodeMirror { height: 300px; }
            .filename-row { flex-direction: column; }
            .app-item { flex-direction: column; gap: 0.5rem; align-items: flex-start; }
            .app-item-actions { width: 100%; justify-content: flex-end; margin-left: 0; }
            .desc-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>RSB Webapps</h1>
    <button class="settings-btn" onclick="openSettings()">&#9881; Einstellungen</button>
</header>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h2>Einstellungen</h2>
        <label for="inputUsername">GitHub-Benutzername</label>
        <input type="text" id="inputUsername" placeholder="z.B. mein-username">

        <label for="inputRepo">Repository-Name</label>
        <input type="text" id="inputRepo" placeholder="z.B. rsb-webapps" value="rsb-webapps">

        <label for="inputToken">Personal Access Token (PAT)</label>
        <input type="password" id="inputToken" placeholder="ghp_...">

        <div class="help-text">
            <strong>So erstellst du einen Fine-grained PAT:</strong><br>
            1. GitHub &rarr; Settings &rarr; Developer Settings &rarr; Fine-grained tokens<br>
            2. &laquo;Generate new token&raquo; klicken<br>
            3. Repository access: &laquo;Only select repositories&raquo; &rarr; dein Repo ausw&auml;hlen<br>
            4. Permissions: &laquo;Contents&raquo; &rarr; Read and Write<br>
            5. Token kopieren und hier einf&uuml;gen
        </div>

        <h3>KI-Beschreibung (optional)</h3>
        <label for="inputClaudeKey">Anthropic API Key</label>
        <input type="password" id="inputClaudeKey" placeholder="sk-ant-...">
        <div class="help-text">
            <strong>F&uuml;r automatische App-Beschreibungen:</strong><br>
            Wenn ein API-Key hinterlegt ist, kann beim Deployen automatisch eine Beschreibung (Fach, Jahrgangsstufe, Kurzbeschreibung) per Claude generiert werden.<br><br>
            Key erstellen: <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeSettings()">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
        </div>
    </div>
</div>

<!-- QR Modal -->
<div class="qr-modal-overlay" id="qrModal" onclick="closeQRModal(event)">
    <div class="qr-modal" onclick="event.stopPropagation()">
        <h3 id="qrModalTitle"></h3>
        <div class="qr-modal-code" id="qrModalCode"></div>
        <div class="qr-modal-url" id="qrModalUrl"></div>
        <div class="qr-modal-actions">
            <button class="btn btn-primary btn-sm" onclick="copyModalUrl()">URL kopieren</button>
            <button class="btn btn-secondary btn-sm" onclick="closeQRModal()">Schlie&szlig;en</button>
        </div>
    </div>
</div>

<div class="container">

    <!-- Setup Banner -->
    <div class="setup-banner" id="setupBanner" style="display:none;">
        Bitte zuerst die GitHub-Einstellungen konfigurieren.
        <button class="btn btn-primary btn-sm" onclick="openSettings()">Jetzt einrichten</button>
    </div>

    <!-- Status Message -->
    <div class="status" id="statusMsg"></div>

    <!-- Editor -->
    <div class="editor-section">
        <h2>Editor</h2>
        <div class="filename-row">
            <input type="text" id="filename" placeholder="dateiname (ohne .html)">
            <span>.html</span>
        </div>
        <textarea id="editor"></textarea>

        <!-- Description fields -->
        <div class="desc-box" id="descBox">
            <div class="desc-row">
                <div>
                    <label for="descFach">Fach</label>
                    <input type="text" id="descFach" placeholder="z.B. BWR, Englisch, Mathematik">
                </div>
                <div>
                    <label for="descStufe">Jahrgangsstufe</label>
                    <input type="text" id="descStufe" placeholder="z.B. 7, 8–10">
                </div>
            </div>
            <label for="descText">Beschreibung</label>
            <textarea id="descText" placeholder="Kurze Beschreibung der App..."></textarea>
        </div>

        <div class="editor-buttons">
            <button class="btn btn-secondary" onclick="showPreview()">Vorschau</button>
            <button class="btn btn-primary" id="aiDescBtn" onclick="generateDescription()">KI-Beschreibung</button>
            <button class="btn btn-success" id="deployBtn" onclick="deploy()">Deploy</button>
            <button class="btn btn-secondary" id="cancelEditBtn" style="display:none;" onclick="cancelEdit()">Bearbeitung abbrechen</button>
        </div>
    </div>

    <!-- Preview -->
    <div class="preview-section" id="previewSection">
        <h2>Vorschau
            <button class="btn btn-secondary btn-sm" onclick="closePreview()" style="margin-left:0.5rem;">Schlie&szlig;en</button>
        </h2>
        <iframe class="preview-frame" id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <!-- App List -->
    <div class="app-list-section">
        <div class="app-list-header">
            <h2>Deployte Apps <span class="app-count" id="appCount"></span></h2>
            <button class="btn btn-secondary btn-sm" onclick="loadApps()">&#8635; Aktualisieren</button>
        </div>
        <div class="filter-bar">
            <input type="text" id="filterSearch" placeholder="Suchen..." oninput="filterApps()">
            <select id="filterFach" onchange="filterApps()">
                <option value="">Alle F&auml;cher</option>
            </select>
            <select id="sortOrder" onchange="filterApps()">
                <option value="newest">Neueste zuerst</option>
                <option value="oldest">&Auml;lteste zuerst</option>
                <option value="name-az">Name A–Z</option>
                <option value="name-za">Name Z–A</option>
                <option value="fach">Nach Fach</option>
            </select>
        </div>
        <div id="appList">
            <div class="app-list-empty">Lade Apps...</div>
        </div>
    </div>

</div>

<script>
    // ----- State -----
    let editor;
    let editingSha = null;
    let editingFilename = null;
    let descriptions = {};
    let descriptionsSha = null;
    let allAppFiles = [];

    // ----- Init -----
    document.addEventListener('DOMContentLoaded', () => {
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: 'htmlmixed',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            tabSize: 2,
            indentWithTabs: false,
            autoCloseBrackets: true
        });

        editor.setValue('<!DOCTYPE html>\n<html lang="de">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Meine App</title>\n  <style>\n    body { font-family: sans-serif; padding: 2rem; }\n  </style>\n</head>\n<body>\n  <h1>Hallo Welt!</h1>\n\n  <script>\n    // Dein JavaScript hier\n  <\/script>\n</body>\n</html>');

        if (!getConfig().token) {
            document.getElementById('setupBanner').style.display = 'block';
        } else {
            loadDescriptions().then(() => loadApps());
        }
    });

    // ----- Settings -----
    function getConfig() {
        return {
            username: localStorage.getItem('rsb_username') || '',
            repo: localStorage.getItem('rsb_repo') || 'rsb-webapps',
            token: localStorage.getItem('rsb_token') || '',
            claudeKey: localStorage.getItem('rsb_claude_key') || ''
        };
    }

    function openSettings() {
        const cfg = getConfig();
        document.getElementById('inputUsername').value = cfg.username;
        document.getElementById('inputRepo').value = cfg.repo;
        document.getElementById('inputToken').value = cfg.token;
        document.getElementById('inputClaudeKey').value = cfg.claudeKey;
        document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettings() {
        document.getElementById('settingsModal').classList.remove('active');
    }

    function saveSettings() {
        const username = document.getElementById('inputUsername').value.trim();
        const repo = document.getElementById('inputRepo').value.trim();
        const token = document.getElementById('inputToken').value.trim();
        const claudeKey = document.getElementById('inputClaudeKey').value.trim();

        if (!username || !repo || !token) {
            alert('Bitte mindestens GitHub-Username, Repo und PAT ausfüllen.');
            return;
        }

        localStorage.setItem('rsb_username', username);
        localStorage.setItem('rsb_repo', repo);
        localStorage.setItem('rsb_token', token);
        localStorage.setItem('rsb_claude_key', claudeKey);

        closeSettings();
        document.getElementById('setupBanner').style.display = 'none';
        showStatus('Einstellungen gespeichert!', 'success');
        loadDescriptions().then(() => loadApps());
    }

    // ----- GitHub API -----
    function apiHeaders() {
        const cfg = getConfig();
        return {
            'Authorization': `Bearer ${cfg.token}`,
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28'
        };
    }

    function apiBase() {
        const cfg = getConfig();
        return `https://api.github.com/repos/${cfg.username}/${cfg.repo}/contents/apps`;
    }

    function repoApiBase() {
        const cfg = getConfig();
        return `https://api.github.com/repos/${cfg.username}/${cfg.repo}/contents`;
    }

    function pagesUrl(filename) {
        const cfg = getConfig();
        return `https://${cfg.username}.github.io/${cfg.repo}/apps/${filename}`;
    }

    // ----- Descriptions -----
    async function loadDescriptions() {
        const cfg = getConfig();
        if (!cfg.token) return;

        try {
            const resp = await fetch(`${repoApiBase()}/descriptions.json`, { headers: apiHeaders() });
            if (!resp.ok) return;
            const data = await resp.json();
            descriptionsSha = data.sha;
            descriptions = JSON.parse(decodeURIComponent(escape(atob(data.content.replace(/\n/g, '')))));
        } catch (e) {
            // descriptions.json doesn't exist yet, that's fine
        }
    }

    async function saveDescriptions() {
        const cfg = getConfig();
        if (!cfg.token) return;

        const body = {
            message: 'Update descriptions.json',
            content: btoa(unescape(encodeURIComponent(JSON.stringify(descriptions, null, 2))))
        };

        if (descriptionsSha) {
            body.sha = descriptionsSha;
        }

        try {
            const resp = await fetch(`${repoApiBase()}/descriptions.json`, {
                method: 'PUT',
                headers: { ...apiHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (resp.ok) {
                const data = await resp.json();
                descriptionsSha = data.content.sha;
            }
        } catch (e) {
            console.error('Fehler beim Speichern der Beschreibungen:', e);
        }
    }

    // ----- Load Apps -----
    async function loadApps() {
        const cfg = getConfig();
        if (!cfg.token) return;

        const listEl = document.getElementById('appList');
        listEl.innerHTML = '<div class="app-list-empty">Lade Apps...</div>';

        try {
            const resp = await fetch(apiBase(), { headers: apiHeaders() });

            if (resp.status === 404) {
                listEl.innerHTML = '<div class="app-list-empty">Noch keine Apps deployt.</div>';
                document.getElementById('appCount').textContent = '';
                return;
            }

            if (!resp.ok) throw new Error(`API-Fehler: ${resp.status}`);

            const files = await resp.json();
            const htmlFiles = Array.isArray(files)
                ? files.filter(f => f.name.endsWith('.html') || f.name.endsWith('.htm'))
                : [];

            // Fetch last commit date for sorting by newest
            const cfg2 = getConfig();
            try {
                const commitsResp = await fetch(
                    `https://api.github.com/repos/${cfg2.username}/${cfg2.repo}/commits?path=apps&per_page=100`,
                    { headers: apiHeaders() }
                );
                if (commitsResp.ok) {
                    const commits = await commitsResp.json();
                    // Build map: filename -> latest commit date
                    const dateMap = {};
                    for (const commit of commits) {
                        const date = commit.commit.committer.date;
                        const msg = commit.commit.message;
                        // Try to extract filename from commit message
                        for (const f of htmlFiles) {
                            if (msg.includes(f.name) && !dateMap[f.name]) {
                                dateMap[f.name] = date;
                            }
                        }
                    }
                    htmlFiles.forEach(f => { f._date = dateMap[f.name] || '2000-01-01'; });
                }
            } catch (e) {
                // Fallback: no date info
                htmlFiles.forEach((f, i) => { f._date = '2000-01-01'; });
            }

            allAppFiles = htmlFiles;

            buildFachFilter();
            renderApps();
        } catch (err) {
            listEl.innerHTML = `<div class="app-list-empty" style="color:#991b1b;">Fehler: ${err.message}</div>`;
        }
    }

    function buildFachFilter() {
        const faecher = new Set();
        allAppFiles.forEach(f => {
            const desc = descriptions[f.name];
            if (desc && desc.fach) faecher.add(desc.fach);
        });

        const select = document.getElementById('filterFach');
        const current = select.value;
        select.innerHTML = '<option value="">Alle Fächer</option>';
        [...faecher].sort().forEach(fach => {
            const opt = document.createElement('option');
            opt.value = fach;
            opt.textContent = fach;
            select.appendChild(opt);
        });
        select.value = current;
    }

    function filterApps() {
        renderApps();
    }

    function renderApps() {
        const listEl = document.getElementById('appList');
        const searchTerm = document.getElementById('filterSearch').value.toLowerCase();
        const fachFilter = document.getElementById('filterFach').value;

        let filtered = allAppFiles.filter(f => {
            const desc = descriptions[f.name];
            const nameMatch = f.name.toLowerCase().includes(searchTerm);
            const descMatch = desc && (
                (desc.beschreibung || '').toLowerCase().includes(searchTerm) ||
                (desc.fach || '').toLowerCase().includes(searchTerm)
            );

            if (searchTerm && !nameMatch && !descMatch) return false;
            if (fachFilter && (!desc || desc.fach !== fachFilter)) return false;
            return true;
        });

        // Sort
        const sortOrder = document.getElementById('sortOrder').value;
        filtered.sort((a, b) => {
            switch (sortOrder) {
                case 'newest': return (b._date || '').localeCompare(a._date || '');
                case 'oldest': return (a._date || '').localeCompare(b._date || '');
                case 'name-az': return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                case 'name-za': return b.name.toLowerCase().localeCompare(a.name.toLowerCase());
                case 'fach':
                    const fa = (descriptions[a.name]?.fach || 'ZZZ').toLowerCase();
                    const fb = (descriptions[b.name]?.fach || 'ZZZ').toLowerCase();
                    return fa.localeCompare(fb) || a.name.localeCompare(b.name);
                default: return 0;
            }
        });

        document.getElementById('appCount').textContent = `(${filtered.length} von ${allAppFiles.length})`;

        if (filtered.length === 0) {
            listEl.innerHTML = '<div class="app-list-empty">Keine Apps gefunden.</div>';
            return;
        }

        listEl.innerHTML = '';
        filtered.forEach(file => {
            const url = pagesUrl(file.name);
            const itemId = 'qr-' + file.name.replace(/[^a-zA-Z0-9]/g, '-');
            const desc = descriptions[file.name];

            let descHtml = '';
            if (desc) {
                descHtml = '<div class="app-item-desc">';
                if (desc.fach) descHtml += `<span class="badge badge-fach">${esc(desc.fach)}</span>`;
                if (desc.stufe) descHtml += `<span class="badge badge-stufe">Jgst. ${esc(desc.stufe)}</span>`;
                if (desc.beschreibung) descHtml += ` ${esc(desc.beschreibung)}`;
                descHtml += '</div>';
            }

            const itemDiv = document.createElement('div');
            itemDiv.innerHTML = `
                <div class="app-item">
                    <div class="app-item-info">
                        <div class="app-item-name">
                            <a href="${url}" target="_blank">${esc(file.name)}</a>
                        </div>
                        ${descHtml}
                    </div>
                    <div class="app-item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="openQRModal('${esc(file.name)}', '${url}')">QR</button>
                        <button class="btn btn-primary btn-sm" onclick="editApp('${esc(file.name)}')">Bearbeiten</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete('${esc(file.name)}', '${file.sha}')">L\u00f6schen</button>
                    </div>
                </div>
            `;
            listEl.appendChild(itemDiv);
        });
    }

    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // ----- QR Modal -----
    let currentModalUrl = '';

    function openQRModal(filename, url) {
        currentModalUrl = url;
        document.getElementById('qrModalTitle').textContent = filename;
        const codeDiv = document.getElementById('qrModalCode');
        codeDiv.innerHTML = '';
        new QRCode(codeDiv, { text: url, width: 200, height: 200 });
        document.getElementById('qrModalUrl').innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
        document.getElementById('qrModal').classList.add('active');
    }

    function closeQRModal(event) {
        if (event && event.target !== document.getElementById('qrModal')) return;
        document.getElementById('qrModal').classList.remove('active');
    }

    function copyModalUrl() {
        navigator.clipboard.writeText(currentModalUrl).then(() => {
            showStatus('URL kopiert!', 'success');
        });
    }

    // ESC key handler
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('qrModal').classList.remove('active');
            document.getElementById('settingsModal').classList.remove('active');
        }
    });

    // ----- Deploy -----
    async function deploy() {
        const cfg = getConfig();
        if (!cfg.token) {
            openSettings();
            return;
        }

        let filename = document.getElementById('filename').value.trim();
        if (!filename) {
            showStatus('Bitte einen Dateinamen eingeben.', 'error');
            return;
        }

        // Sanitize filename
        filename = filename.replace(/\.html$/i, '');
        filename = filename.replace(/[^a-zA-Z0-9_\-]/g, '-').toLowerCase();
        if (!filename) {
            showStatus('Ungültiger Dateiname.', 'error');
            return;
        }
        filename += '.html';

        const content = editor.getValue();
        if (!content.trim()) {
            showStatus('Der Editor ist leer.', 'error');
            return;
        }

        const deployBtn = document.getElementById('deployBtn');
        deployBtn.disabled = true;
        deployBtn.innerHTML = '<span class="spinner"></span>Deploying...';

        try {
            const body = {
                message: `Deploy ${filename}`,
                content: btoa(unescape(encodeURIComponent(content)))
            };

            // If editing an existing file, include the SHA
            if (editingSha && editingFilename === filename) {
                body.sha = editingSha;
                body.message = `Update ${filename}`;
            } else {
                try {
                    const checkResp = await fetch(`${apiBase()}/${filename}`, { headers: apiHeaders() });
                    if (checkResp.ok) {
                        const existing = await checkResp.json();
                        body.sha = existing.sha;
                        body.message = `Update ${filename}`;
                    }
                } catch (e) {}
            }

            const resp = await fetch(`${apiBase()}/${filename}`, {
                method: 'PUT',
                headers: { ...apiHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!resp.ok) {
                const errData = await resp.json();
                throw new Error(errData.message || `HTTP ${resp.status}`);
            }

            // Save description if fields are filled
            const fach = document.getElementById('descFach').value.trim();
            const stufe = document.getElementById('descStufe').value.trim();
            const beschreibung = document.getElementById('descText').value.trim();

            if (fach || stufe || beschreibung) {
                descriptions[filename] = { fach, stufe, beschreibung };
                await saveDescriptions();
            }

            const url = pagesUrl(filename);
            showStatus(`Erfolgreich deployt: ${filename}`, 'success');
            generateQR(url);
            cancelEdit();
            loadApps();
        } catch (err) {
            showStatus(`Deploy fehlgeschlagen: ${err.message}`, 'error');
        } finally {
            deployBtn.disabled = false;
            deployBtn.textContent = 'Deploy';
        }
    }

    // ----- Claude AI Description -----
    async function generateDescription() {
        const cfg = getConfig();
        if (!cfg.claudeKey) {
            showStatus('Bitte zuerst einen Anthropic API Key in den Einstellungen hinterlegen.', 'error');
            openSettings();
            return;
        }

        const content = editor.getValue();
        if (!content.trim()) {
            showStatus('Der Editor ist leer – bitte zuerst Code einfügen.', 'error');
            return;
        }

        const btn = document.getElementById('aiDescBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner spinner-dark"></span>Generiere...';

        // Show description box
        document.getElementById('descBox').classList.add('active');

        try {
            const resp = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': cfg.claudeKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-5-20250929',
                    max_tokens: 300,
                    messages: [{
                        role: 'user',
                        content: `Analysiere diese HTML-Webapp für Schüler einer bayerischen Realschule. Antworte NUR mit einem JSON-Objekt (ohne Markdown, ohne Code-Block), mit genau diesen drei Feldern:
- "fach": Das Unterrichtsfach (z.B. "BWR", "Englisch", "Mathematik", "WR", "Physik", "Biologie", "Französisch", "Deutsch", "Informatik", "Geographie", "Sport", "Fächerübergreifend" oder "Tool")
- "stufe": Die passende Jahrgangsstufe(n) (z.B. "7", "8–10", "5–6")
- "beschreibung": Eine kurze Beschreibung der App in einem Satz (max. 80 Zeichen, auf Deutsch)

HTML-Code:
${content.substring(0, 6000)}`
                    }]
                })
            });

            if (!resp.ok) {
                const err = await resp.json();
                throw new Error(err.error?.message || `HTTP ${resp.status}`);
            }

            const data = await resp.json();
            let text = data.content[0].text.trim();
            // Strip markdown code block if present
            text = text.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/,'');
            const parsed = JSON.parse(text);

            document.getElementById('descFach').value = parsed.fach || '';
            document.getElementById('descStufe').value = parsed.stufe || '';
            document.getElementById('descText').value = parsed.beschreibung || '';

            showStatus('Beschreibung generiert! Bitte prüfen und bei Bedarf anpassen.', 'success');
        } catch (err) {
            showStatus(`KI-Beschreibung fehlgeschlagen: ${err.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'KI-Beschreibung';
        }
    }

    // ----- Edit App -----
    async function editApp(filename) {
        showStatus('Lade Datei...', 'info');

        try {
            const resp = await fetch(`${apiBase()}/${filename}`, { headers: apiHeaders() });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

            const data = await resp.json();
            const content = decodeURIComponent(escape(atob(data.content.replace(/\n/g, ''))));

            editor.setValue(content);
            document.getElementById('filename').value = filename.replace(/\.html?$/i, '');
            editingSha = data.sha;
            editingFilename = filename;

            // Load existing description if available
            const desc = descriptions[filename];
            if (desc) {
                document.getElementById('descFach').value = desc.fach || '';
                document.getElementById('descStufe').value = desc.stufe || '';
                document.getElementById('descText').value = desc.beschreibung || '';
                document.getElementById('descBox').classList.add('active');
            } else {
                document.getElementById('descFach').value = '';
                document.getElementById('descStufe').value = '';
                document.getElementById('descText').value = '';
                document.getElementById('descBox').classList.remove('active');
            }

            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            showStatus(`Bearbeite: ${filename}`, 'info');
            document.querySelector('.editor-section').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            showStatus(`Fehler beim Laden: ${err.message}`, 'error');
        }
    }

    function cancelEdit() {
        editingSha = null;
        editingFilename = null;
        document.getElementById('cancelEditBtn').style.display = 'none';
        document.getElementById('filename').value = '';
        document.getElementById('descFach').value = '';
        document.getElementById('descStufe').value = '';
        document.getElementById('descText').value = '';
        document.getElementById('descBox').classList.remove('active');
    }

    // ----- Delete App -----
    async function confirmDelete(filename, sha) {
        if (!confirm(`"${filename}" wirklich löschen?`)) return;
        await deleteApp(filename, sha);
    }

    async function deleteApp(filename, sha) {
        try {
            showStatus(`Lösche ${filename}...`, 'info');

            const resp = await fetch(`${apiBase()}/${filename}`, {
                method: 'DELETE',
                headers: { ...apiHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Delete ${filename}`,
                    sha: sha
                })
            });

            if (!resp.ok) {
                const errData = await resp.json();
                throw new Error(errData.message || `HTTP ${resp.status}`);
            }

            // Remove description
            if (descriptions[filename]) {
                delete descriptions[filename];
                await saveDescriptions();
            }

            showStatus(`${filename} gelöscht.`, 'success');
            loadApps();
        } catch (err) {
            showStatus(`Fehler beim Löschen: ${err.message}`, 'error');
        }
    }

    // ----- QR Code (after deploy) -----
    function generateQR(url) {
        // Extract filename from URL
        const parts = url.split('/');
        const filename = parts[parts.length - 1];
        openQRModal(filename, url);
    }

    // ----- Preview -----
    function showPreview() {
        const content = editor.getValue();
        const section = document.getElementById('previewSection');
        const frame = document.getElementById('previewFrame');

        section.classList.add('active');
        frame.srcdoc = content;
        section.scrollIntoView({ behavior: 'smooth' });
    }

    function closePreview() {
        const section = document.getElementById('previewSection');
        section.classList.remove('active');
        document.getElementById('previewFrame').srcdoc = '';
    }

    // ----- Status -----
    function showStatus(message, type) {
        const el = document.getElementById('statusMsg');
        el.textContent = message;
        el.className = `status active ${type}`;

        if (type === 'success') {
            setTimeout(() => { el.classList.remove('active'); }, 4000);
        }
    }
</script>

</body>
</html>
