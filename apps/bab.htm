<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnowPro BAB-Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Entfernt die Spinner bei Number-Inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-blue-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">SnowPro GmbH</h1>
                <p class="text-blue-100 text-sm">Bad Reichenhall • CEO: Max Winter</p>
            </div>
            <div class="text-right">
                <div class="text-xs uppercase font-semibold tracking-wider opacity-80">BAB Training</div>
                <div id="progress-text" class="text-xl font-bold">1 / 4</div>
            </div>
        </div>

        <div class="w-full bg-slate-200 h-2">
            <div id="progress-bar" class="bg-blue-400 h-2 transition-all duration-500" style="width: 25%"></div>
        </div>

        <div class="p-8">
            
            <div id="game-container">
                <div class="mb-8 bg-blue-50 border border-blue-100 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span id="cost-name">Miete</span>
                        <span class="text-sm font-normal text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">Verteilschlüssel: <span id="dist-key-name">Fläche</span></span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Zu verteilender Gesamtbetrag:</p>
                            <p class="text-3xl font-bold text-blue-600" id="total-amount">12.000,00 €</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Basis-Info:</p>
                            <p class="text-slate-700" id="key-info">Gesamtfläche: 1.200 m²</p>
                            <p class="text-xs text-slate-400 mt-1">Hinweis: Berechne den Satz pro Einheit (Gesamt : Basis).</p>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-slate-500 text-sm border-b border-slate-200">
                                <th class="py-3 px-4 font-semibold w-1/4">I: Material</th>
                                <th class="py-3 px-4 font-semibold w-1/4">II: Fertigung</th>
                                <th class="py-3 px-4 font-semibold w-1/4">III: Verwaltung</th>
                                <th class="py-3 px-4 font-semibold w-1/4">IV: Vertrieb</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-slate-50">
                                <td class="py-2 px-4 text-xs text-slate-500 border-r border-slate-200">
                                    <span id="key-mat">200</span> <span class="unit-label">m²</span>
                                </td>
                                <td class="py-2 px-4 text-xs text-slate-500 border-r border-slate-200">
                                    <span id="key-fert">800</span> <span class="unit-label">m²</span>
                                </td>
                                <td class="py-2 px-4 text-xs text-slate-500 border-r border-slate-200">
                                    <span id="key-verw">100</span> <span class="unit-label">m²</span>
                                </td>
                                <td class="py-2 px-4 text-xs text-slate-500">
                                    <span id="key-vert">100</span> <span class="unit-label">m²</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="p-2 border-r border-slate-100">
                                    <div class="relative">
                                        <input type="number" id="input-mat" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-right" placeholder="0,00">
                                        <span class="absolute right-8 top-3 text-slate-400 text-sm">€</span>
                                    </div>
                                </td>
                                <td class="p-2 border-r border-slate-100">
                                    <div class="relative">
                                        <input type="number" id="input-fert" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-right" placeholder="0,00">
                                        <span class="absolute right-8 top-3 text-slate-400 text-sm">€</span>
                                    </div>
                                </td>
                                <td class="p-2 border-r border-slate-100">
                                    <div class="relative">
                                        <input type="number" id="input-verw" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-right" placeholder="0,00">
                                        <span class="absolute right-8 top-3 text-slate-400 text-sm">€</span>
                                    </div>
                                </td>
                                <td class="p-2">
                                    <div class="relative">
                                        <input type="number" id="input-vert" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-right" placeholder="0,00">
                                        <span class="absolute right-8 top-3 text-slate-400 text-sm">€</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="feedback-msg" class="h-6 mt-2 text-sm text-red-500 font-semibold text-center opacity-0 transition-opacity">
                    Überprüfe die rot markierten Felder. Die Summe stimmt nicht oder die Verteilung ist falsch.
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="checkAnswers()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                        Weiter &rarr;
                    </button>
                </div>
            </div>

            <div id="success-screen" class="hidden text-center py-10">
                <div class="mb-6 inline-flex items-center justify-center w-24 h-24 bg-green-100 rounded-full text-green-600 text-5xl">
                    ✓
                </div>
                <h2 class="text-3xl font-bold text-slate-800 mb-4">Fantastisch!</h2>
                <p class="text-slate-600 mb-8 max-w-md mx-auto">Du hast den Betriebsabrechnungsbogen für SnowPro erfolgreich und fehlerfrei ausgefüllt. Max Winter wäre stolz!</p>
                <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    Nochmal starten
                </button>
            </div>

        </div>
    </div>

    <script>
        // SnowPro Kontext Daten
        const exercises = [
            {
                name: "Miete (Produktionshalle & Büro)",
                keyName: "Fläche",
                unit: "m²",
                totalAmount: 12000,
                totalKey: 1200, // 10€ pro qm
                keys: { mat: 200, fert: 800, verw: 100, vert: 100 }
            },
            {
                name: "Strom (Maschinen & Licht)",
                keyName: "Verbrauch",
                unit: "kWh",
                totalAmount: 4500,
                totalKey: 45000, // 0.10€ pro kWh
                keys: { mat: 5000, fert: 35000, verw: 2000, vert: 3000 }
            },
            {
                name: "Kalk. Abschreibung (Maschinenpark)",
                keyName: "Anlagewerte (Verhältnis)",
                unit: "Pkt.",
                totalAmount: 24000,
                totalKey: 12, // 2000€ pro Punkt
                keys: { mat: 2, fert: 8, verw: 1, vert: 1 }
            },
            {
                name: "Freiwillige Sozialkosten",
                keyName: "Mitarbeiteranzahl",
                unit: "MA",
                totalAmount: 8500,
                totalKey: 85, // 100€ pro MA
                keys: { mat: 10, fert: 55, verw: 12, vert: 8 }
            }
        ];

        let currentStep = 0;

        // Hilfsfunktion zum Formatieren von Währung
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(num);
        };

        // UI Initialisieren
        function loadStep() {
            const data = exercises[currentStep];
            
            // Header Infos
            document.getElementById('progress-text').innerText = `${currentStep + 1} / ${exercises.length}`;
            document.getElementById('progress-bar').style.width = `${((currentStep + 1) / exercises.length) * 100}%`;
            
            // Textinhalte
            document.getElementById('cost-name').innerText = data.name;
            document.getElementById('dist-key-name').innerText = data.keyName;
            document.getElementById('total-amount').innerText = formatCurrency(data.totalAmount);
            document.getElementById('key-info').innerText = `Gesamtbasis: ${new Intl.NumberFormat('de-DE').format(data.totalKey)} ${data.unit}`;

            // Tabellenwerte
            document.querySelectorAll('.unit-label').forEach(el => el.innerText = data.unit);
            document.getElementById('key-mat').innerText = data.keys.mat;
            document.getElementById('key-fert').innerText = data.keys.fert;
            document.getElementById('key-verw').innerText = data.keys.verw;
            document.getElementById('key-vert').innerText = data.keys.vert;

            // Inputs leeren & Styles resetten
            ['mat', 'fert', 'verw', 'vert'].forEach(id => {
                const input = document.getElementById(`input-${id}`);
                input.value = '';
                input.classList.remove('border-red-500', 'bg-red-50');
                input.classList.add('border-slate-300');
            });
            
            document.getElementById('feedback-msg').classList.add('opacity-0');
            document.getElementById('input-mat').focus();
        }

        function checkAnswers() {
            const data = exercises[currentStep];
            const factor = data.totalAmount / data.totalKey;
            
            // Erwartete Werte berechnen
            const expected = {
                mat: data.keys.mat * factor,
                fert: data.keys.fert * factor,
                verw: data.keys.verw * factor,
                vert: data.keys.vert * factor
            };

            let allCorrect = true;

            ['mat', 'fert', 'verw', 'vert'].forEach(id => {
                const input = document.getElementById(`input-${id}`);
                // Komma zu Punkt ersetzen für JS Parsing
                const userVal = parseFloat(input.value.replace(',', '.')) || 0;
                const correctVal = expected[id];

                // Toleranz für kleine Rundungsfehler (0.01)
                if (Math.abs(userVal - correctVal) > 0.02) {
                    allCorrect = false;
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-slate-300');
                } else {
                    input.classList.remove('border-red-500', 'bg-red-50');
                    input.classList.add('border-green-500', 'bg-green-50');
                }
            });

            if (allCorrect) {
                if (currentStep < exercises.length - 1) {
                    currentStep++;
                    // Kleiner Timeout für besseres UX
                    setTimeout(() => loadStep(), 400);
                } else {
                    finishGame();
                }
            } else {
                const msg = document.getElementById('feedback-msg');
                msg.classList.remove('opacity-0');
                // Shake effect
                const btn = document.querySelector('button');
                btn.classList.add('animate-pulse');
                setTimeout(() => btn.classList.remove('animate-pulse'), 500);
            }
        }

        function finishGame() {
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('success-screen').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '100%';
            triggerConfetti();
        }

        function triggerConfetti() {
            var duration = 3000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function(min, max) {
            return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            var particleCount = 50 * (timeLeft / duration);
            // Konfetti von links und rechts schießen
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // Enter-Taste Support
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkAnswers();
            }
        });

        // Start
        loadStep();
    </script>
</body>
</html>