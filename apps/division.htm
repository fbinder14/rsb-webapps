```html
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schriftliche Division – Dezimalbrüche Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white/80 backdrop-blur shadow-lg rounded-2xl border border-slate-200; }
    .step-badge { @apply inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-900 text-white text-sm font-semibold mr-2; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .grid-fit { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .nr { @apply bg-slate-50 rounded-xl border border-slate-200 p-3 mono; }
    .nr pre { line-height: 1.5; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 text-slate-900">
  <header class="max-w-5xl mx-auto px-4 pt-6 pb-3">
    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Schriftliche Division mit Dezimalbrüchen</h1>
    <p class="text-slate-600 mt-1">Interaktive Schritt-für-Schritt-Erklärung – mit Nebenrechnung wie im Heft.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Steuerleiste -->
    <section class="card p-4 sm:p-6 mb-4">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
        <div class="flex-1">
          <label class="block text-sm font-medium text-slate-700 mb-1">Aufgabe (Dividend : Divisor)</label>
          <div class="flex gap-2">
            <input id="dividendInput" class="w-1/2 sm:w-1/3 card border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 mono" placeholder="z. B. 273" />
            <span class="self-center text-lg font-semibold">:</span>
            <input id="divisorInput" class="w-1/2 sm:w-1/3 card border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 mono" placeholder="z. B. 3" />
          </div>
          <p class="text-xs text-slate-500 mt-1">Komma bitte mit „,“ eingeben (deutsches Format).</p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 flex-none w-full sm:w-auto">
          <button id="btnRandom" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 active:scale-[.99] transition">Zufallsaufgabe</button>
          <button id="btnStart" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-500 active:scale-[.99] transition col-span-1 sm:col-span-2">Start</button>
          <select id="selSchwierigkeit" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">
            <option value="easy">Leicht</option>
            <option value="mid" selected>Mittel</option>
            <option value="hard">Anspruchsvoll</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section class="grid gap-4 sm:gap-6 grid-fit">
      <article class="card p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">Aufgabe</h2>
        <div id="aufgabe" class="text-xl sm:text-2xl font-bold mono">—</div>
        <div class="mt-2 text-slate-600 text-sm" id="aufgabeHinweis"></div>
      </article>

      <article class="card p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Schritte</h2>
          <div class="flex gap-2">
            <button id="btnStep" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-40">Nächster Schritt</button>
            <button id="btnAll" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 border border-slate-300">Alle zeigen</button>
            <button id="btnReset" class="px-3 py-2 rounded-xl bg-white border border-slate-300 hover:bg-slate-100">Zurücksetzen</button>
          </div>
        </div>
        <ol id="steps" class="space-y-3"></ol>
      </article>

      <article class="card p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">Nebenrechnung (wie im Heft)</h2>
        <div id="neben" class="space-y-3 text-sm"></div>
      </article>

      <article class="card p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">Ergebnis</h2>
        <div class="text-2xl font-bold mono" id="ergebnis">—</div>
        <p class="text-slate-600 text-sm mt-1" id="ergebnisHinweis"></p>
      </article>
    </section>

    <!-- Erklärungskasten -->
    <section class="card p-4 sm:p-6 mt-4 sm:mt-6">
      <h2 class="text-lg font-semibold mb-2">So geht’s – Kurzüberblick</h2>
      <ul class="list-disc pl-5 space-y-1 text-slate-700 text-sm leading-relaxed">
        <li><span class="font-semibold">Normieren:</span> Hat der Divisor ein Komma, verschieben wir bei Dividend und Divisor das Komma gleich weit nach rechts, bis der Divisor ganzzahlig ist.</li>
        <li><span class="font-semibold">Schriftliche Division:</span> Links beginnen, Ziffer „herunterholen“, passende Ziffer schätzen, <span class="mono">Divisor · Ziffer</span> bilden, abziehen, nächste Ziffer holen.</li>
        <li><span class="font-semibold">Komma im Ergebnis:</span> Das Komma kommt in den Quotienten, sobald wir die ursprüngliche Kommaposition des Dividenden überschreiten.</li>
        <li><span class="font-semibold">Abbruch:</span> Rest <span class="mono">0</span> → fertig; sonst mit angehängten Nullen Nachkommastellen bilden.</li>
      </ul>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">
    © 2025 • Lern-Dashboard • Mobile-optimiert
  </footer>

  <script>
    // --- Hilfsfunktionen (deutsches Zahlenformat, Zeichen: · und :) ---
    const toGerman = (x, max = null) => {
      if (!isFinite(x)) return '—';
      const opt = { useGrouping: true };
      if (typeof max === 'number') { opt.minimumFractionDigits = 0; opt.maximumFractionDigits = max; }
      return x.toLocaleString('de-DE', opt);
    };
    const strToNumber = (s) => {
      if (typeof s !== 'string') return NaN;
      s = s.trim().replace(/\./g, '').replace(',', '.');
      return Number(s);
    };
    const formatComma = (num, minFrac = 0, maxFrac = 20) => {
      if (!isFinite(num)) return '—';
      return num.toLocaleString('de-DE', { minimumFractionDigits: minFrac, maximumFractionDigits: maxFrac });
    };
    const countDecimals = (value) => {
      const s = String(value);
      if (!s.includes('.')) return 0;
      return s.split('.')[1].replace(/0+$/, '').length;
    };

    // Zufallsaufgaben
    function randomProblem(level='mid') {
      const rInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
      const rPick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
      let dividend, divisor;

      if (level === 'easy') {
        dividend = (rInt(10, 999) / rPick([1,10])).toFixed(rPick([0,1]));
        divisor  = (rInt(2, 9)   / rPick([1,10])).toFixed(rPick([0,1]));
      } else if (level === 'hard') {
        dividend = (rInt(100, 9999) / rPick([1,10,100])).toFixed(rPick([1,2]));
        divisor  = (rInt(12, 97)    / rPick([1,10])).toFixed(rPick([1,2]));
      } else {
        dividend = (rInt(50, 1999) / rPick([1,10])).toFixed(rPick([0,1,2]));
        divisor  = (rInt(7, 79)    / rPick([1,10])).toFixed(rPick([0,1]));
      }
      dividend = Number(dividend);
      divisor  = Number(divisor);
      if (!isFinite(dividend) || !isFinite(divisor) || divisor === 0) {
        return randomProblem(level);
      }
      return { dividend, divisor };
    }

    // Nebenrechnungs-Bausteine (wie im Screenshot)
    function nrMultiplikation(V, q, prod) {
      return `<div class="nr"><pre>${V} · ${q} = ${prod}</pre></div>`;
    }
    function nrSubtraktion(part, vTimesQ, rest) {
      // sauber untereinander ausrichten
      const a = String(part), b = String(vTimesQ), r = String(rest);
      const pad = Math.max(a.length, b.length, r.length);
      const A = a.padStart(pad, ' '), B = b.padStart(pad, ' '), R = String(rest).padStart(pad, ' ');
      return `<div class="nr"><pre>  ${A}
- ${B}
  ${'—'.repeat(pad)}
  ${R}</pre></div>`;
    }

    // Kernalgorithmus: erzeugt Schritte; JEDE Rechenziffer bringt sofort die passende Nebenrechnung mit
    function longDivisionSteps(dividend, divisor, maxDecimalPlaces = 8, maxIterations = 200) {
      const steps = [];

      if (divisor === 0) {
        steps.push({ title: "Division durch 0 nicht definiert", detail: "Der Divisor darf nicht 0 sein." });
        return { steps, quotient: "—", info: "Fehler" };
      }

      const sDividend = String(dividend);
      const sDivisor  = String(divisor);
      const dDec = countDecimals(sDividend);
      const vDec = countDecimals(sDivisor);
      const shift = vDec;
      const factor = Math.pow(10, shift);

      const D = Math.round(dividend * Math.pow(10, shift));
      const V = Math.round(divisor  * Math.pow(10, shift));

      steps.push({
        title: "Normieren",
        detail:
          vDec === 0
            ? "Der Divisor ist bereits ganzzahlig. Keine Verschiebung nötig."
            : `Komma ${shift} Stelle(n) nach rechts: ${formatComma(dividend)} → ${formatComma(dividend * factor)} und ${formatComma(divisor)} → ${formatComma(divisor * factor)}.`
      });

      let digits = String(Math.abs(D)).split('').map(d=>Number(d));
      if (digits.length === 0) digits = [0];

      let commaAfter = digits.length - (dDec + shift);
      if (commaAfter < 0) {
        digits = Array(Math.abs(commaAfter)).fill(0).concat(digits);
        commaAfter = 0;
      }

      let idx = 0;
      let current = 0;
      let quotientDigits = [];
      let placedComma = false;
      let producedDecimals = 0;

      steps.push({
        title: "Start",
        detail: `Wir teilen jetzt ${toGerman(Math.abs(D))} : ${toGerman(Math.abs(V))} schriftlich.`
      });

      let iter = 0;
      while (iter < maxIterations) {
        iter++;

        if (!placedComma && quotientDigits.length === commaAfter) {
          if (quotientDigits.length === 0) quotientDigits.push('0');
          quotientDigits.push(',');
          placedComma = true;
          steps.push({
            title: "Komma im Ergebnis",
            detail: "Wir haben die Kommaposition des Dividenden überschritten. Daher setzen wir jetzt das Komma."
          });
        }

        if (idx < digits.length) {
          const nextDigit = digits[idx];
          const before = current;
          current = current * 10 + nextDigit;
          steps.push({
            title: "Ziffer herunterholen",
            detail: `Hole die Ziffer ${nextDigit} herunter: ${before} → ${current}.`
          });
          idx++;
        } else {
          if (current === 0) break;
          if (producedDecimals >= maxDecimalPlaces) break;
          if (!placedComma) {
            quotientDigits.push(',');
            placedComma = true;
            steps.push({ title: "Komma im Ergebnis", detail: "Keine Ziffern mehr – wir setzen das Komma und hängen Nullen an." });
          }
          current = current * 10;
          producedDecimals++;
          steps.push({
            title: "Null anhängen",
            detail: "Wir hängen eine 0 an, um weiterzurechnen."
          });
        }

        if (current < Math.abs(V)) {
          if (quotientDigits.length > 0 || placedComma) {
            quotientDigits.push('0');
            steps.push({
              title: "Ziffer bestimmen",
              detail: `${current} ist kleiner als ${Math.abs(V)} → Ziffer 0.`,
              nebenHtml: nrMultiplikation(Math.abs(V), 0, 0) + nrSubtraktion(current, 0, current)
            });
          }
          continue;
        }

        // Ziffer schätzen und Nebenrechnung direkt beilegen
        const q = Math.floor(current / Math.abs(V));
        const prod = q * Math.abs(V);
        const rest = current - prod;

        quotientDigits.push(String(q));
        steps.push({
          title: "Ziffer bestimmen",
          detail: `Wie oft passt ${Math.abs(V)} in ${current}? → ${q}-mal.`,
          nebenHtml: nrMultiplikation(Math.abs(V), q, prod)
        });
        steps.push({
          title: "Subtrahieren",
          detail: `${current} − ${prod} = ${rest}.`,
          nebenHtml: nrSubtraktion(current, prod, rest)
        });

        current = rest;

        if (current === 0 && idx >= digits.length) {
          steps.push({ title: "Fertig", detail: "Rest 0 – die Division ist abgeschlossen." });
          break;
        }
      }

      // Quotientenstring
      let qStr = quotientDigits.join('');
      if (qStr.startsWith(',')) qStr = '0' + qStr;
      if (qStr.endsWith(',')) qStr = qStr.slice(0, -1);
      if (qStr.includes(',')) {
        qStr = qStr.replace(/,(\d*?)0+$/, (m, g1) => g1.length ? ',' + g1 : '');
        if (qStr.endsWith(',')) qStr = qStr.slice(0, -1);
      }

      const info = `Berechnet mit bis zu ${maxDecimalPlaces} Nachkommastellen.`;
      return { steps, quotient: qStr || '0', info };
    }

    // --- UI Logik ---
    const $ = (sel)=>document.querySelector(sel);
    const stepsList = $('#steps');
    const nebenBox = $('#neben');
    const aufgabeBox = $('#aufgabe');
    const aufgabeHinweis = $('#aufgabeHinweis');
    const ergebnisBox = $('#ergebnis');
    const ergebnisHinweis = $('#ergebnisHinweis');

    let currentState = {
      dividend: null,
      divisor: null,
      steps: [],
      shown: 0,
      quotient: '—',
      info: ''
    };

    function renderAufgabe() {
      if (currentState.dividend == null) {
        aufgabeBox.textContent = '—';
        aufgabeHinweis.textContent = '';
        return;
      }
      aufgabeBox.textContent = `${formatComma(currentState.dividend)} : ${formatComma(currentState.divisor)}`;
      aufgabeHinweis.textContent = 'Lies: „Dividend : Divisor“.';
    }

    function clearRender() {
      stepsList.innerHTML = '';
      nebenBox.innerHTML = '';
      ergebnisBox.textContent = '—';
      ergebnisHinweis.textContent = '';
    }

    function renderNebenBis(stepCount) {
      const html = [];
      for (let i = 0; i < stepCount; i++) {
        const s = currentState.steps[i];
        if (s && s.nebenHtml) html.push(s.nebenHtml);
      }
      nebenBox.innerHTML = html.join('');
    }

    function renderNextStep() {
      if (currentState.shown >= currentState.steps.length) return;
      const i = currentState.shown;
      const s = currentState.steps[i];

      const li = document.createElement('li');
      li.className = 'p-3 rounded-xl bg-slate-50 border border-slate-200';
      li.innerHTML = `
        <div class="flex items-start">
          <span class="step-badge">${i + 1}</span>
          <div>
            <div class="font-semibold">${s.title}</div>
            <div class="text-slate-700 text-sm mt-0.5">${s.detail}</div>
          </div>
        </div>
      `;
      stepsList.appendChild(li);

      currentState.shown++;
      renderNebenBis(currentState.shown);

      if (currentState.shown === currentState.steps.length) {
        ergebnisBox.textContent = currentState.quotient;
        ergebnisHinweis.textContent = currentState.info + ' (Komma nach deutschem Schema).';
      }
      updateButtons();
    }

    function renderAll() {
      stepsList.innerHTML = '';
      currentState.steps.forEach((s, i) => {
        const li = document.createElement('li');
        li.className = 'p-3 rounded-xl bg-slate-50 border border-slate-200';
        li.innerHTML = `
          <div class="flex items-start">
            <span class="step-badge">${i + 1}</span>
            <div>
              <div class="font-semibold">${s.title}</div>
              <div class="text-slate-700 text-sm mt-0.5">${s.detail}</div>
            </div>
          </div>
        `;
        stepsList.appendChild(li);
      });
      currentState.shown = currentState.steps.length;
      renderNebenBis(currentState.shown);
      ergebnisBox.textContent = currentState.quotient;
      ergebnisHinweis.textContent = currentState.info + ' (Komma nach deutschem Schema).';
      updateButtons();
    }

    function updateButtons() {
      $('#btnStep').disabled = currentState.shown >= currentState.steps.length;
    }

    function startFromInputs() {
      const d = strToNumber($('#dividendInput').value);
      const v = strToNumber($('#divisorInput').value);
      if (!isFinite(d) || !isFinite(v) || v === 0) {
        alert('Bitte gültige Zahlen eingeben. Der Divisor darf nicht 0 sein. Dezimal-Komma: „,“');
        return;
      }
      beginSession(d, v);
    }

    function beginSession(dividend, divisor) {
      currentState.dividend = dividend;
      currentState.divisor  = divisor;
      clearRender();
      renderAufgabe();

      const { steps, quotient, info } = longDivisionSteps(dividend, divisor, 8, 300);
      currentState.steps = steps;
      currentState.quotient = quotient;
      currentState.info = info;
      currentState.shown = 0;
      updateButtons();
    }

    // Events
    $('#btnRandom').addEventListener('click', () => {
      const lvl = $('#selSchwierigkeit').value;
      const { dividend, divisor } = randomProblem(lvl);
      $('#dividendInput').value = formatComma(dividend);
      $('#divisorInput').value  = formatComma(divisor);
      beginSession(dividend, divisor);
    });

    $('#btnStart').addEventListener('click', startFromInputs);
    $('#btnStep').addEventListener('click', renderNextStep);
    $('#btnAll').addEventListener('click', renderAll);
    $('#btnReset').addEventListener('click', () => {
      currentState = { dividend:null, divisor:null, steps:[], shown:0, quotient:'—', info:'' };
      $('#dividendInput').value = '';
      $('#divisorInput').value  = '';
      clearRender();
      renderAufgabe();
      updateButtons();
    });

    // Tastatur: Enter = Start, Pfeil rechts = nächster Schritt
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (document.activeElement.id === 'dividendInput' || document.activeElement.id === 'divisorInput')) {
        startFromInputs();
      } else if (e.key === 'ArrowRight') {
        if (!$('#btnStep').disabled) renderNextStep();
      }
    });

    // Erste Zufallsaufgabe laden
    (function init() {
      const { dividend, divisor } = randomProblem('mid');
      $('#dividendInput').value = formatComma(dividend);
      $('#divisorInput').value  = formatComma(divisor);
      beginSession(dividend, divisor);
    })();
  </script>
</body>
</html>
```
